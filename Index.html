<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Inteligente con Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .day-cell { transition: all 0.2s ease-in-out; }
        .day-cell.selected { background-color: #3b82f6; color: white; border-radius: 50%; }
        .day-cell.today { background-color: #f3f4f6; color: #1d4ed8; font-weight: 700; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); }
        .day-cell:hover:not(.empty) { background-color: #dbeafe; cursor: pointer; }
        .day-cell.selected:hover { background-color: #2563eb; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hourly-timeline { position: relative; height: 1440px; }
        .hour-slot { height: 60px; border-top: 1px solid #e5e7eb; }
        .hour-label { position: absolute; transform: translateY(-50%); font-size: 0.75rem; color: #6b7280; padding-right: 0.5rem; }
        .timeline-event { position: absolute; left: 45px; right: 5px; border-radius: 0.5rem; padding: 4px 8px; color: white; font-size: 0.75rem; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p class="text-gray-600">Conectando a tu calendario...</p>
    </div>

    <div id="main-grid" class="max-w-screen-2xl mx-auto flex flex-col lg:grid lg:grid-cols-3 gap-8 transition-all duration-500">
        <!-- Calendar Column -->
        <div id="calendar-column" class="order-1 lg:order-1 lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg transition-all duration-500">
            <div class="flex items-center justify-between mb-6">
                <h2 id="month-year" class="text-2xl font-bold text-gray-700"></h2>
                <div class="flex items-center space-x-2">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left fa-fw"></i></button>
                    <button id="today-btn" class="text-sm font-semibold px-4 py-2 rounded-lg hover:bg-gray-200">Hoy</button>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right fa-fw"></i></button>
                </div>
            </div>
            <div class="grid calendar-grid gap-2 text-center text-sm font-semibold text-gray-500 mb-2">
                <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
            </div>
            <div id="calendar-days" class="grid calendar-grid gap-2"></div>
        </div>
        
        <!-- Daily View Column -->
        <div id="daily-view-panel" class="order-3 lg:order-2 hidden bg-white p-6 rounded-2xl shadow-lg flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="daily-view-header" class="text-lg font-bold text-gray-700"></h3>
                <button id="close-daily-view" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="daily-view-content" class="overflow-y-auto flex-grow pr-2">
                 <div id="hourly-timeline-container" class="hourly-timeline"></div>
            </div>
        </div>

        <!-- Event Manager Column -->
        <div id="event-manager-column" class="order-2 lg:order-3 lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg flex flex-col transition-all duration-500">
            <h3 class="text-xl font-bold mb-4 text-gray-700">Gestor de Eventos</h3>

            <!-- Add New Event Type -->
            <div class="mb-6">
                <h4 class="font-semibold mb-2 text-gray-600">Crear botón de evento</h4>
                <div class="space-y-3">
                    <input type="text" id="event-name-input" placeholder="Nombre (ej: Trabajo)" class="w-full px-3 py-2 border rounded-lg">
                    <div class="flex gap-2">
                        <input type="time" id="event-start-time-input" class="w-full px-3 py-2 border rounded-lg">
                        <input type="time" id="event-end-time-input" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <button id="add-event-type-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Crear</button>
                </div>
            </div>

            <!-- Custom Event Buttons -->
            <div class="mb-6">
                <h4 class="font-semibold mb-2 text-gray-600">Añadir evento rápido</h4>
                <div id="custom-event-buttons" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Events of the selected day -->
            <div class="flex-grow flex flex-col min-h-0">
                <h4 id="selected-day-header" class="font-semibold mb-2 text-gray-600">Eventos del día</h4>
                <div id="event-list" class="flex-grow bg-gray-50 p-3 rounded-lg overflow-y-auto">
                    <p id="no-events-message" class="text-gray-500 text-center mt-4">Selecciona un día.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FIREBASE SCRIPT IMPORTS -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainGrid = document.getElementById('main-grid');
        const calendarColumn = document.getElementById('calendar-column');
        const eventManagerColumn = document.getElementById('event-manager-column');
        const dailyViewPanel = document.getElementById('daily-view-panel');
        const dailyViewHeader = document.getElementById('daily-view-header');
        const hourlyTimelineContainer = document.getElementById('hourly-timeline-container');
        const closeDailyViewBtn = document.getElementById('close-daily-view');
        const monthYearEl = document.getElementById('month-year');
        const calendarDaysEl = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayBtn = document.getElementById('today-btn');
        const eventNameInput = document.getElementById('event-name-input');
        const eventStartTimeInput = document.getElementById('event-start-time-input');
        const eventEndTimeInput = document.getElementById('event-end-time-input');
        const addEventTypeBtn = document.getElementById('add-event-type-btn');
        const customEventButtonsEl = document.getElementById('custom-event-buttons');
        const selectedDayHeaderEl = document.getElementById('selected-day-header');
        const eventListEl = document.getElementById('event-list');
        const noEventsMessage = document.getElementById('no-events-message');

        // --- APP STATE ---
        let currentDate = new Date();
        let selectedDate = null;
        let events = {};
        let customEventTypes = [];
        let db, auth, userId, docRef; // Firebase variables
        let unsubscribe; // To detach Firestore listener

        // --- FIREBASE SETUP ---
async function initializeFirebase() {        
const firebaseConfig = {
  apiKey: "AIzaSyCmjNSi2GIt0Gqdqub-yCgmxP98wZux7xU",
  authDomain: "calendar-basic-72988.firebaseapp.com",
  projectId: "calendar-basic-72988",
  storageBucket: "calendar-basic-72988.firebasestorage.app",
  messagingSenderId: "602458142783",
  appId: "1:602458142783:web:a038c595cf9df109aae08a"
}; 
const appId = firebaseConfig.appId

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                 loadingOverlay.innerHTML = '<p class="text-red-500">Error: Configuración de Firebase no encontrada. Reemplaza el objeto `firebaseConfig` en el código con tus claves.</p>';
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) {
                    try {
                        await signInWithCustomToken(auth, authToken);
                    } catch (tokenError) {
                        console.warn("Custom token sign-in failed, falling back to anonymous sign-in.", tokenError);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                if (!auth.currentUser) throw new Error("Authentication failed.");
                userId = auth.currentUser.uid;
                docRef = doc(db, 'artifacts', appId, 'users', userId);
                setupRealtimeListener();
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">Error de autenticación.</p>';
            }
        }
        
        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    events = data.events || {};
                    customEventTypes = data.customEventTypes || getDefaultEventTypes();
                } else {
                    console.log("No data found for user, creating new document.");
                    events = {};
                    customEventTypes = getDefaultEventTypes();
                    saveStateToFirestore(); 
                }
                renderAll();
                loadingOverlay.style.display = 'none';
            }, (error) => {
                console.error("Firestore listener error:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">Error al cargar datos.</p>';
            });
        }

        function getDefaultEventTypes() {
            return [
                { name: 'Trabajo', startTime: '09:00', endTime: '17:00', color: 'bg-blue-500' },
                { name: 'Gimnasio', startTime: '18:00', endTime: '19:00', color: 'bg-green-500' },
                { name: 'Comer', startTime: '13:30', endTime: '14:30', color: 'bg-yellow-500' },
            ];
        }

        // --- DATA PERSISTENCE ---
        async function saveStateToFirestore() {
            if (!docRef) return;
            try {
                await setDoc(docRef, { events, customEventTypes });
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // --- UTILITY & RENDER FUNCTIONS ---
        const timeToMinutes = (timeStr) => {
            if(!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };
        
        function renderAll() {
            renderCalendar();
            renderCustomEventButtons();
            renderEventList();
            if (selectedDate) renderDailyView();
        }
        
        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = `${new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase()}`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startDayOfWeek = new Date(year, month, 1).getDay();
            if (startDayOfWeek === 0) startDayOfWeek = 7;
            const startingOffset = startDayOfWeek - 1;
            for (let i = 0; i < startingOffset; i++) calendarDaysEl.appendChild(document.createElement('div'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                dayCell.className = 'day-cell relative h-12 md:h-16 flex items-center justify-center rounded-full';
                dayCell.textContent = day;
                dayCell.dataset.date = dateString;
                if (dateString === new Date().toISOString().split('T')[0]) dayCell.classList.add('today');
                if (selectedDate === dateString) dayCell.classList.add('selected');
                if (events[dateString] && events[dateString].length > 0) {
                    const eventDot = document.createElement('div');
                    eventDot.className = 'event-dot bg-red-500';
                    dayCell.appendChild(eventDot);
                }
                dayCell.addEventListener('click', () => handleDayClick(dateString));
                calendarDaysEl.appendChild(dayCell);
            }
        }

        function renderCustomEventButtons() {
            customEventButtonsEl.innerHTML = '';
            if(customEventTypes.length === 0) {
                customEventButtonsEl.innerHTML = `<p class="text-sm text-gray-400 w-full">Crea tu primer botón.</p>`;
                return;
            }
            customEventTypes.forEach((eventType, index) => {
                const button = document.createElement('button');
                button.className = `text-white font-semibold py-2 px-3 rounded-lg text-sm flex items-center gap-2 hover:opacity-90 transition-opacity ${eventType.color}`;
                button.innerHTML = `<span>${eventType.name}</span><i class="fas fa-times-circle fa-xs" data-index="${index}"></i>`;
                button.addEventListener('click', (e) => {
                    if (e.target.tagName === 'I') {
                        e.stopPropagation();
                        customEventTypes.splice(index, 1);
                        saveStateToFirestore();
                    } else {
                        addEventToSelectedDay(eventType);
                    }
                });
                customEventButtonsEl.appendChild(button);
            });
        }

        function renderEventList() {
            eventListEl.innerHTML = '';
            noEventsMessage.style.display = 'block';
            if (!selectedDate) {
                selectedDayHeaderEl.textContent = 'Eventos del día';
                return;
            }
            noEventsMessage.style.display = 'none';
            const date = new Date(selectedDate + 'T00:00:00');
            selectedDayHeaderEl.textContent = `Eventos para ${date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`;
            const dayEvents = events[selectedDate] || [];
            if (dayEvents.length === 0) {
                eventListEl.innerHTML = '<p class="text-gray-500 text-center mt-4">No hay eventos.</p>';
            } else {
                const sortedEvents = [...dayEvents].sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));
                sortedEvents.forEach((event) => {
                    const eventItemContainer = document.createElement('div');
                    eventItemContainer.className = `p-3 rounded-lg mb-2 text-white ${event.color}`;

                    eventItemContainer.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${event.name}</p>
                                <p class="text-sm opacity-90">${event.startTime || ''} - ${event.endTime || ''}</p>
                            </div>
                            <button class="delete-event-btn text-white opacity-70 hover:opacity-100 flex-shrink-0" data-group-id="${event.groupId}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    
                    eventItemContainer.querySelector('.delete-event-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const groupIdToDelete = e.currentTarget.dataset.groupId;
                        handleDeleteEventGroup(groupIdToDelete);
                    });
                    eventListEl.appendChild(eventItemContainer);
                });
            }
        }

        function renderDailyView() {
            hourlyTimelineContainer.innerHTML = '';
            if (!selectedDate) return;
            const date = new Date(selectedDate + 'T00:00:00');
            dailyViewHeader.textContent = `Horario del ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}`;
            for (let hour = 0; hour < 24; hour++) {
                const hourSlot = document.createElement('div');
                hourSlot.className = 'hour-slot relative';
                const label = document.createElement('span');
                label.className = 'hour-label';
                label.textContent = `${String(hour).padStart(2, '0')}:00`;
                label.style.top = `${hour * 60}px`;
                hourlyTimelineContainer.appendChild(label);
            }
            const dayEvents = events[selectedDate] || [];
            dayEvents.forEach(event => {
                const startMinutes = timeToMinutes(event.startTime);
                const endMinutes = timeToMinutes(event.endTime);
                const duration = endMinutes - startMinutes;
                if (duration <= 0) return;
                const eventDiv = document.createElement('div');
                eventDiv.className = `timeline-event ${event.color}`;
                eventDiv.style.top = `${startMinutes}px`;
                eventDiv.style.height = `${duration}px`;
                eventDiv.innerHTML = `<p class="font-bold">${event.name}</p><p>${event.startTime} - ${event.endTime}</p>`;
                hourlyTimelineContainer.appendChild(eventDiv);
            });
        }
        
        // --- LAYOUT UPDATE ---
        function updateLayout(isDaySelected) {
            mainGrid.classList.toggle('lg:grid-cols-3', !isDaySelected);
            mainGrid.classList.toggle('lg:grid-cols-12', isDaySelected);
            calendarColumn.classList.toggle('lg:col-span-2', !isDaySelected);
            calendarColumn.classList.toggle('lg:col-span-5', isDaySelected);
            eventManagerColumn.classList.toggle('lg:col-span-1', !isDaySelected);
            eventManagerColumn.classList.toggle('lg:col-span-3', isDaySelected);
            dailyViewPanel.classList.toggle('hidden', !isDaySelected);
            dailyViewPanel.classList.toggle('lg:col-span-4', isDaySelected);
            dailyViewPanel.classList.toggle('flex', isDaySelected);
        }
        
        // --- EVENT HANDLERS ---
        function handleDayClick(dateString) {
            selectedDate = dateString;
            updateLayout(true);
            renderAll();
            document.getElementById('daily-view-content').scrollTop = 480;
        }

        /**
         * Maneja la creación de eventos, incluyendo los que cruzan la medianoche.
         * @param {object} eventType - El objeto base del evento (nombre, hora inicio/fin).
         */
        function addEventToSelectedDay(eventType) {
            if (!selectedDate) {
                alert('Por favor, primero selecciona un día en el calendario.');
                return;
            }

            const { name, startTime, endTime } = eventType;
            if (!name || !startTime || !endTime) {
                alert('El evento debe tener un nombre y horas de inicio y fin.');
                return;
            }

            const startDate = new Date(selectedDate + 'T00:00:00');
            const groupId = crypto.randomUUID(); // ID común para todas las partes del evento

            const baseEventType = customEventTypes.find(e => e.name.toLowerCase() === eventType.name.toLowerCase()) || {};
            const colors = ['bg-red-500', 'bg-purple-500', 'bg-indigo-500', 'bg-pink-500', 'bg-orange-500', 'bg-teal-500'];
            const color = baseEventType.color || colors[Math.floor(Math.random() * colors.length)];

            // Comprueba si el evento cruza la medianoche (la hora de fin es menor que la de inicio)
            const spansMidnight = endTime < startTime;

            if (!spansMidnight) {
                // Evento normal de un solo día
                const dateKey = startDate.toISOString().split('T')[0];
                if (!events[dateKey]) events[dateKey] = [];
                
                events[dateKey].push({
                    id: crypto.randomUUID(),
                    groupId: groupId,
                    name: name,
                    startTime: startTime,
                    endTime: endTime,
                    color: color
                });

            } else {
                // El evento se divide en dos días
                // Parte 1: Desde la hora de inicio hasta el final del primer día (23:59)
                const firstDayKey = startDate.toISOString().split('T')[0];
                if (!events[firstDayKey]) events[firstDayKey] = [];
                
                events[firstDayKey].push({
                    id: crypto.randomUUID(),
                    groupId: groupId,
                    name: name,
                    startTime: startTime,
                    endTime: '23:59',
                    color: color
                });

                // Parte 2: Desde el inicio del segundo día (00:00) hasta la hora de fin
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 1);
                const secondDayKey = endDate.toISOString().split('T')[0];
                if (!events[secondDayKey]) events[secondDayKey] = [];

                events[secondDayKey].push({
                    id: crypto.randomUUID(),
                    groupId: groupId,
                    name: name,
                    startTime: '00:00',
                    endTime: endTime,
                    color: color
                });
            }
            
            saveStateToFirestore();
        }

        /**
         * Maneja la eliminación de un grupo de eventos completo.
         * @param {string} groupIdToDelete - El ID del grupo a eliminar.
         */
        function handleDeleteEventGroup(groupIdToDelete) {
            if (!groupIdToDelete) return;

            // Itera sobre todas las fechas en el objeto de eventos
            for (const dateKey in events) {
                if (Object.hasOwnProperty.call(events, dateKey)) {
                    // Filtra los eventos, quedándose solo con los que NO coinciden con el groupId
                    const updatedEvents = events[dateKey].filter(event => event.groupId !== groupIdToDelete);

                    if (updatedEvents.length === 0) {
                        // Si no quedan eventos para esta fecha, elimina la fecha del objeto
                        delete events[dateKey];
                    } else {
                        // Si quedan, actualiza la lista de eventos para esa fecha
                        events[dateKey] = updatedEvents;
                    }
                }
            }
            saveStateToFirestore();
        }
        
        // --- INITIALIZATION ---
        addEventTypeBtn.addEventListener('click', () => {
            const name = eventNameInput.value.trim();
            if (!name || !eventStartTimeInput.value || !eventEndTimeInput.value) {
                alert('Completa todos los campos para crear un tipo de evento.'); return;
            }
            const colors = ['bg-red-500', 'bg-purple-500', 'bg-indigo-500', 'bg-pink-500', 'bg-orange-500', 'bg-teal-500'];
            customEventTypes.push({ name, startTime: eventStartTimeInput.value, endTime: eventEndTimeInput.value, color: colors[customEventTypes.length % colors.length] });
            saveStateToFirestore();
            eventNameInput.value = ''; eventStartTimeInput.value = ''; eventEndTimeInput.value = '';
        });
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); });
        todayBtn.addEventListener('click', () => { currentDate = new Date(); selectedDate = currentDate.toISOString().split('T')[0]; updateLayout(true); renderAll(); });
        closeDailyViewBtn.addEventListener('click', () => { selectedDate = null; updateLayout(false); renderAll(); });

        initializeFirebase();
    </script>
</body>
</html>
